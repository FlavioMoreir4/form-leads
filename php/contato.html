<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/FlavioMoreiraTec/projs@master/style.css" />

<input type="button" data-target="modal_contato" data-toggle="modal" data-whatever="diadema" value="Entrar em contato">

<div id="modal_contato" class="modal">
    <div class="modal-window large modal-content">
        <form name="contato">
            <div class="modal-header">
                <span class="close" data-dismiss="modal">&times;</span>
                <h5 class="modal-title" id="modalLabel">Nova mensagem</h5>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="nome" class="col-form-label">Nome completo</label>
                    <input type="text" class="form-control formVal" id="nome" name="nome">
                </div>

                <div class="form-group">
                    <label for="email" class="col-form-label">Email</label>
                    <input type="email" class="form-control formVal" id="email" name="email">
                </div>

                <div class="form-group">
                    <label for="whatsapp" class="col-form-label">WhatsApp</label>
                    <input type="tel" class="form-control formVal" id="whatsapp" name="whatsapp" maxlength="15">
                </div>

                <div class="form-group">
                    <label for="message-text" class="col-form-label">Mensagem</label>
                    <textarea class="form-control formVal" id="mensagem" name="mensagem"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <input type="text" id="destinatario" class="formVal" name="destinatario">
                <input type="button" class="btn btn-default" data-dismiss="modal" value="Fechar">
                <input type="submit" class="btn btn-primary" data-submit="modal" value="Enviar">
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/FlavioMoreiraTec/projs@master/scripts.js"></script>
<script>
    document.addEventListener("click", function (e) {
        e = e || window.event;
        var target = e.target || e.srcElement;
        if (target.hasAttribute("data-toggle") && target.getAttribute("data-toggle") == "modal") {
            if (target.hasAttribute("data-target")) {
                Consult("https://ipadraomilitar.com.br/api/ajax.php", "r=" + target.dataset.whatever)
                    .then(res => res.json())
                    .then(function (json) {
                        for (row in json) {
                            console.log(json[row].email_ipmil)
                            id("destinatario").value = json[row].email_ipmil
                        }
                    })
                var m_ID = target.getAttribute("data-target");
                document.getElementById(m_ID).classList.add("open");
                e.preventDefault();
            }
        }
        if ((target.hasAttribute("data-dismiss") && target.getAttribute("data-dismiss") == "modal") || target
            .classList.contains("modal")) {
            var modal = document.querySelector("[class='modal open']");
            modal.classList.remove("open");
            e.preventDefault();
        }
        if ((target.hasAttribute("data-submit") && target.getAttribute("data-submit") == "modal")) {
            e.preventDefault();
            fetch("https://ipadraomilitar.com.br/api/mail.php", {
                    method: 'POST',
                    body: new FormData(document.forms["contato"])
                })
                .then(response => showSuccessMessage(response))
                .catch(error => console.log('Error!', error));
        }

        function showLoadingIndicator() {
            document.forms["contato"].reset()

        }

        function showSuccessMessage(response) {
            showLoadingIndicator()
            console.log("Success!", response)
        }

        function showErrorMessage(error) {
            console.error("Error!", error.message)
        }
    }, false);

    window.onload = function () {
        id('whatsapp').onkeyup = function () {
            mask(this, mtel);
        }
    }
</script>